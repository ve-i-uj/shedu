input{
    file{
        path => "/opt/kbengine/assets/logs/*.log"
        start_position => beginning
    }
}

# input { stdin { } }

filter {
  mutate {
    strip => "message"
    add_field => { "[log][file][path]" => "path" }
  }

  if ![message] {
    drop { }
  }

  grok {
    match => {
      "[log][file][path]" => "%{GREEDYDATA}/%{GREEDYDATA:filename}\.log"
    }
  }

  if ( [filename] =~ /^logger_.*/ ) {
    # Это логи от компонентов, отправленные в Логгер
    grok {
      patterns_dir => "/usr/share/logstash/config/patterns/"
      match => {
        "message" => "%{KBE_LOG_LEVEL:kbe_log_level}%{SPACE}%{COMPONENT_NAME:component_name} %{NUMBER:uid} %{NUMBER:cid}%{SPACE}\[%{KBE_TIMESTAMP:kbe_timestamp}] -%{LOG_MESSAGE}"
      }
    }
  }
  else {
    # Это логи от компонентов, которые пишут сами в файл, а не отправляют в Логгер
    grok {
      patterns_dir => "/usr/share/logstash/config/patterns/"
      match => {
        "message" => "%{KBE_LOG_LEVEL:kbe_log_level}%{SPACE}%{COMPONENT_NAME:component_name} \[%{KBE_TIMESTAMP_MACHINE:kbe_timestamp}\] -%{LOG_MESSAGE}"
      }
    }
  }

  # Время в логах от самих компонентах и в логах Логера в разных форматах.
  # Приведём время к единому формату
  date {
    match => [ "kbe_timestamp" , "yyyy-MM-dd HH:mm:ss,SSS" , "yyyy-MM-dd HH:mm:ss SSS" ]
    target => "@timestamp"
    remove_field => ["kbe_timestamp"]
  }

  if ![logmessage] {
    drop { }
  }

  if "_grokparsefailure" in [tags] {
    if "[GCC 4.8.5 20150623 (Red Hat 4.8.5-44)])!" in [message]  {
      drop { }
    }
    mutate {
      add_field => { "[@metadata][index_prefix]" => "failure" }
    }
  } else if ![component_name] {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "unknown" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "kbe-logs" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://kbe-log-elk-elastic:9200"]
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
  }
}

# output {
#   stdout {
#     codec => rubydebug {
#       metadata => true
#     }
#   }
# }
