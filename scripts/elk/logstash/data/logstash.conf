input{
    file{
        path => "/opt/kbengine/assets/logs/*.log"
        start_position => beginning
    }
}

# input { stdin { } }

filter {
  mutate {
    strip => "message"
    add_field => { "[log][file][path]" => "path" }
  }

  if ![message] {
    drop { }
  }

  if [log][file][path] =~ "/opt/kbengine/assets/logs/logger_.+\.log" {
    grok {
      patterns_dir => "/usr/share/logstash/config/patterns/"
      match => {
        "message" => "%{KBE_LOG_LEVEL:kbe_log_level}%{SPACE}%{COMPONENT_NAME:component_name} %{NUMBER:uid} %{NUMBER:cid}%{SPACE}\[%{KBE_TIMESTAMP:kbe_timestamp}] -%{SPACE}%{GREEDYDATA:logmessage}"
      }
    }
  } else {
    grok {
      patterns_dir => "/usr/share/logstash/config/patterns/"
      match => {
        "message" => "%{KBE_LOG_LEVEL:kbe_log_level}%{SPACE}%{COMPONENT_NAME:component_name} \[%{KBE_TIMESTAMP_MACHINE:kbe_timestamp_machine}\] -%{SPACE}%{GREEDYDATA:logmessage}"
      }
    }
  }
  grok {
    match => {
      "[log][file][path]" => "%{GREEDYDATA}/%{GREEDYDATA:filename}\.log"
    }
  }

  if ![logmessage] {
    drop { }
  }

  if "_grokparsefailure" in [tags] {
    if "[GCC 4.8.5 20150623 (Red Hat 4.8.5-44)])!" in [message]  {
      drop { }
    }
    mutate {
      add_field => { "[@metadata][index_prefix]" => "failure" }
    }
  } else if ![component_name] {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "unknown" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "kbe-logs" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://kbe-log-elk-elastic:9200"]
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
  }
}

# output {
#   stdout {
#     codec => rubydebug {
#       metadata => true
#     }
#   }
# }
